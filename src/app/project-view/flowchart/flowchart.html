<div class="flow-wrapper">
  <f-flow
    class="flow-root"
    fDraggable
    fEmitOnNodeIntersect
    (fNodeIntersectedWithConnections)="onNodeIntersectedWithConnection($event)"
    (fLoaded)="onLoaded()"
    (fCreateNode)="onCreateNode($event)"
    (fCreateConnection)="addConnection($event)"
  >
    <f-background class="flow-bg">
      <f-circle-pattern color="#4a5565"></f-circle-pattern>
    </f-background>

    <f-canvas fZoom class="flow-canvas">
      <f-connection-for-create
        fType="segment"
        [fStartColor]="isDarkMode() ? '#EEE5E9' : '#131217'"
        [fEndColor]="isDarkMode() ? '#EEE5E9' : '#131217'"
      ></f-connection-for-create>

      <f-snap-connection
        [fSnapThreshold]="50"
        fType="segment"
        [fStartColor]="isDarkMode() ? '#EEE5E9' : '#131217'"
        [fEndColor]="isDarkMode() ? '#EEE5E9' : '#131217'"
      ></f-snap-connection>

      <!-- Start Node -->
      <div
        fNode
        [fNodeId]="'start-node'"
        [fNodePosition]="{ x: 300, y: 0 }"
        class="node"
        [attr.data-node-id]="'start-node'"
        #nodeElement
      >
        <div class="node-title">Start</div>
        <div
          fNodeOutput
          fOutputConnectableSide="bottom"
          [fOutputId]="'start-node-output'"
          [fOutputMultiple]="true"
          class="port port-bottom"
        ></div>
      </div>

      <!-- Connections (mission + ad-hoc merged in TS) -->
      @for (connection of connections(); track connection.outputId + '-' + connection.inputId) {
        <f-connection
          [fConnectionId]="connection.id"
          [fReassignDisabled]="true"
          fType="segment"
          [fOutputId]="connection.outputId"
          [fInputId]="connection.inputId"
          [fStartColor]="isDarkMode() ? '#EEE5E9' : '#131217'"
          [fEndColor]="isDarkMode() ? '#EEE5E9' : '#131217'"
        ></f-connection>
      }

      <!-- Nodes (mission + ad-hoc merged in TS) -->
      @for (node of nodes(); track node.id) {
        <div
          fNode
          fDragHandle
          [fNodeId]="node.id"
          [fNodePosition]="node.position"
          class="node"
          [attr.data-node-id]="node.id"
          (contextmenu)="onRightClick($event, node.id)"
          (fNodePositionChange)="onNodeMoved(node.id, $event)"
          #nodeElement
        >
          <div
            fNodeInput
            fInputConnectableSide="top"
            [fInputId]="node.id + '-input'"
            class="port port-top"
          ></div>

          <div class="node-title">{{ node.text }}</div>

          @if (node.step.arguments && node.step.arguments.length > 0) {
            <div class="node-args">
              @for (arg of node.step.arguments; track arg.name) {
                <div class="arg">
                  <label
                    class="arg-label"
                    pTooltip="{{ arg.name }} ({{ arg.type }})"
                    tooltipPosition="top"
                    [showDelay]="150"
                    [hideDelay]="50"
                    tooltipStyleClass="!max-w-[24rem] !break-words"
                  >
                    {{ arg.name }} ({{ arg.type }})
                  </label>

                  @if (arg.type === 'bool') {
                    <p-checkbox
                      [(ngModel)]="node.args[arg.name]"
                      [binary]="true"
                      class="mx-auto"
                    ></p-checkbox>
                  } @else if (arg.type === 'str') {
                    <input
                      pInputText
                      [(ngModel)]="node.args[arg.name]"
                      class="arg-input"
                      [placeholder]="arg.default || ('Enter ' + arg.name)"
                    />
                  } @else if (arg.type === 'float') {
                    <p-inputNumber
                      [(ngModel)]="node.args[arg.name]"
                      mode="decimal"
                      [minFractionDigits]="1"
                      [maxFractionDigits]="2"
                      styleClass="arg-number"
                      inputStyleClass="arg-input"
                      [placeholder]="'Enter ' + arg.name"
                    ></p-inputNumber>
                  }
                </div>
              }
            </div>
          }

          <div
            fNodeOutput
            fOutputConnectableSide="bottom"
            [fOutputId]="node.id + '-output'"
            [fOutputMultiple]="true"
            class="port port-bottom"
          ></div>
        </div>
      }
    </f-canvas>
  </f-flow>

  <!-- Append to body so it never shifts layout -->
  <p-contextMenu #cm [model]="items" [appendTo]="'body'"></p-contextMenu>

  <!-- Floating toolbar (IntelliJ-like) -->
  <div class="run-toolbar">
    <button class="ide-btn" (click)="onRun('normal')" aria-label="Run" pTooltip="Run" tooltipPosition="left">
      <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false" class="icon-run">
        <polygon points="10,6 10,26 24,16" />
      </svg>
    </button>
    <button class="ide-btn debug" (click)="onRun('debug')" aria-label="Debug" pTooltip="Debug" tooltipPosition="left">
      <!-- Debug bug icon -->
      <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false" class="icon-debug" xmlns="http://www.w3.org/2000/svg">
        <g fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="16" cy="18" r="7" />
          <circle cx="16" cy="9" r="3" />
          <line x1="16" y1="12" x2="16" y2="25" />
          <line x1="9" y1="15" x2="4" y2="13" />
          <line x1="23" y1="15" x2="28" y2="13" />
          <line x1="9" y1="21" x2="4" y2="23" />
          <line x1="23" y1="21" x2="28" y2="23" />
          <line x1="14" y1="6" x2="12" y2="4" />
          <line x1="18" y1="6" x2="20" y2="4" />
        </g>
      </svg>
    </button>
  </div>
</div>
